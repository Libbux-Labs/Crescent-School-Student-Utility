<!DOCTYPE html>
<html>
    <head>
        <link type="text/css" rel="stylesheet" href="main.css">
        <script type="text/javascript" src="cordova-2.2.0.js"></script>
        <script type="text/javascript" src="js/jquery.min.js"></script>
           <!-- <script type="text/javascript" src="jquery.min.js"></script>
            <script type="text/javascript" src="jquery-mobile.min.js"></script>-->
            <script type="text/javascript" src="js/jquery-mobile.min.js"></script>
            <script type="text/javascript" src="apprise-1.5.min.js"></script>
            <link rel="stylesheet" href="apprise.min.css" type="text/css" />
    </head>
    <body>
       
        <div data-role="page">
        <!-- Sorry about the ridiculous amount of nesting here, IT ALMOST LOOKS LIKE GREENROOM! Just trying to keep it centred on various devices.
         Hey, at least I'm using HTML5! -->
            <section class="wrapper" data-role="page">
                <section class="content" data-role="content">
                    <section class="login-wrapper">
                        
                        <img class="login-clogo" src="clogo.png" />
                        <div class="login-loader">
                            <img src="ajax-loader.gif" id="loader-img" />
                            <p id="loader-message"></p>
                        </div>
                        
                        <form class="login-form" id="login-form">
                            <label for="username" class="ui-hidden-accessible">Username:</label>
                            <input type="text" name="username" class="l-username" placeholder="Username" value="">
                                <br>
                                <label for="password" class="ui-hidden-accessible">Password:</label>
                                <input type="password" name="password" class="l-password" placeholder="Password" value="">
                                    <br>
                                    
                                    <a class="login-button button" data-transition="flip">Login<span style="font-family:Entypo;">&#59234;</span></a>
                        </form>

                        
                    </section> <!-- End of the .login-wrapper section -->
                    
                    
                    <script type="text/javascript">
                        $.mobile.loadingMessage = false; // This should probably always be the first line
                        $('.login-loader').hide();

                        // Evaluate the necessity of this plugin - pretty sure it doesn't even work
                        $.fn.center = function() {
                            this.css({
                                'position': 'fixed',
                                'left': '50%',
                                'top': '50%'
                            });
                            this.css({
                                'margin-left': -this.width() / 2 + 'px',
                                'margin-top': -this.height() / 2 + 'px'
							});
                            
                            return this;
                        }


                        function showFormError() {
                            $('.l-password').css('transition','all 0.5s');
                            $('.l-password').css('border', '1px solid #FF0000');
                            $('.l-username').css('transition','all 0.5s');
                            $('.l-username').css('border', '1px solid #FF0000');
                        }

                        if(window.width >= 768 && window.height >= 1024 || window.height == 768) {
                       // $('body').center();
                        //$('.login-wrapper').center();
                        }

                        if(localStorage.username && localStorage.password && localStorage.username != "" && localStorage.password != "") { // The latter half (where we check to see if the username and password [in localStorage] are empty) is the other end of the hack up on the main page that clears the username and password from localStorage when the logout button (#logout-button) is clicked.
                            $('.l-username').val(localStorage.username);
                            $('.l-password').val(localStorage.password);
                        }
                    
                        $('.login-button').touchstart(function(){ // When they tap "login"
                    
                            // Don't worry about blank spaces or control characters in these strings,
                            // they are validated (properly) on the server side.
                            var username = $('.l-username').val();
                            var password = $('.l-password').val();
                                                 
                            // Validation
                            // This is some very simple form validation. It just checks for blank fields.
                            if(username == "" || username == " " || password == "" || password == " ") {
                                apprise("Please enter your Greenroom username!", {'animate':true});	
                                showFormError();
                                die(); // Kill it with fire, to avoid any other problems
                            } // fi username and password fields blank
                                                 
                                                 
                                                 // One last check just to be sure, then log them in and 
                                                 
                                                 else if(username != "" && password != "" && username != " " && password != " ") { // If their credentials look ok
                                                 
                                                 $('.login-loader').fadeIn('fast');
                                                    function nextMsg() {
                                                        if (messages.length == 0) {
                                                            $('#loader-message').html("This app is run by unionized servers. They like to take their time.");
                                                        } else {
                                                        $('#loader-message').html(messages.pop()).fadeIn(0).delay(700).fadeOut(500, nextMsg);
                                                    }
                                                };

                                                var messages = [
                                                    "Encoding...",
                                                    "Hiding from the NSA...",
                                                    "Sending to the NSA...",
                                                    "Receiving from the NSA...",
                                                    "Notifying FBI Cyber Crimes...",
                                                    "Waiting for the government to respond...",
                                                    "Something might have gone wrong",
                                                    "Loading.",
                                                    "Loading..",
                                                    "Loading...",
                                                    "Loading....",
                                                    "Loading.....",
                                                    "Loading......"
                                                ].reverse();

                                                nextMsg();

                                                var url = "http://wylienet.thelibbster.com/liv.php/user/auth";
                                                 
                                                var data = $('#login-form').serialize(); //Serialize the form data
                                                

                                                $.ajax({
                                                    url: url,
                                                    type: 'POST',
                                                    data: data,
                                                    dataType: 'json',
                                                    crossDomain: true,
                                                    statusCode: {
                                                        500: function() {
                                                            apprise("The app is currently unavailable. We apologize for the inconvenience");
                                                        }
                                                    },
                                                    success: function(jsonResponse) {
                                                        if(jsonResponse.auth === "success") {
                                                            console.log("Auth success, proceding");
                                                            localStorage.username = username;
                                                            localStorage.password = password;
                                                            console.log("Credentials saved to localStorage");
                                                            $(location).attr('href',"main1.html");
                                                        } else {

                                                        }
                                                    },
                                                    error: function(jsonResponse) {
                                                        apprise("There was a problem with your connection. Be sure that your device is connected to the Internet and try again.", {animation: true});
                                                    }
                                                }); // end of $.ajax

                                                // $.post(url, data)  // No semicolon!! (breaks the script)
                                                //     .success(function(result) { // If it works
                                                //         //var response = jQuery.parseJSON(result);
                                                       
                                                //        alert(response);
                                                //         var response = jQuery.parseJSON(result);

                                                //         if (response.auth === "success") {
                                                //             alert("mission really succesful");
                                                //         } else {
                                                //             alert("There was a serious problem");
                                                //         }
                                                //         // if(response.auth === "success") { // The initial auth script (auth.php) echo's out the username which it logged in. This statement just makes sure that it logged in the same username that we supplied it (stored in the 'username' variable.)
                                                //         //    localStorage.username = username;
                                                //         //    localStorage.password = password;
                                                //         //    alert("mission actually successful");
                                                //         //    $(location).attr('href',"main1.html");
                                                //         // } 
                                                //         // else if (response.auth === "fail") {
                                                //         //     apprise("Username or password incorrect.", {'animate':true});
                                                //         // } else {
                                                //         //     alert("There was a serious problem");
                                                //         // }
                                                //     }) // End of ".success"

                                                //     .error(function() { // If it don't work
                                                //         apprise('Sorry, there was a problem. Please check your internet connection. Do you want to try again?', {'animate':true, 'verify':true}, function(y){
                                                //                 if(y) { // If they click "yes" - NOTE: THIS IS A RECURSIVE FUNCTION (see above line)
                                                //                     $('.login-button').trigger('touchstart');
                                                //                     //setTimeout(function() {$(location).attr('href',"index.html");},1500);
                                                //                 } else { // If they click "no"
                                                //                     apprise("Please try again later.", {'animate':true});
                                                //                     setTimeout(function() {$(location).attr('href',"index.html");},1500);
                                                //                 }   
                                                //         });
                                                //         $('.login-loader').fadeOut('1500');
                                                //      //   setTimeout(function() {$(location).attr('href',"index.html");},5000);
                                                //         die(); // Kill the script
                                                //         });
                                                //  return false; // Don't know why this has to be here, but it has to be here. DON'T REMOVE IT!
                                                 
                                                 } // End of the else if that the submitted credentials aren't blank
                                                 }); // End of the top level "touchstart" event handler, when they clicked "login".
                        
                        </script>
                    
                    <div class="home-masthead">By Jonathan Libby & Matthew Cheung</div> <!-- Ya, I put Matthew's name here. Oh well, I tried. -->
                    
                </section> <!-- Ending of all those nested elements -->
            </section>
        </div>
    </body>
</html>